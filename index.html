<!doctype html>
<html lang="de">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Notizen</title>

    <!-- Manifest: extern statt eingebettet -->
    <link rel="manifest" href="manifest.webmanifest" />
    <link rel="icon" type="image/svg+xml" href="icon.svg" />

    <style>
        /* Minimal / mobile-first (gekÃ¼rzt) */
        :root {
            --muted: #6b7280;
            --accent: #2563eb;
            --danger: #ef4444;
            --r: 8px;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            font-family:
                system-ui,
                -apple-system,
                "Segoe UI",
                Roboto;
            padding: 4px;
            color: #111;
        }

        .wrap {
            max-width: 1100px;
            margin: 0 auto;
            width: 100%;
        }

        #noteInput {
            width: 100%;
            padding: 14px;
            font-size: 16px;
            font-family: sans-serif;
            border-radius: var(--r);
            border: 1px solid #ccc;
            background: var(--card);
            min-height: 110px;
            max-height: 50vh;
            resize: vertical;
            margin-top: 8px;
            margin-bottom: 8px;
            box-sizing: border-box;
        }

        #noteInput:focus {
            outline: 1px solid #aaa;
            border-color: #aaa;
        }

        .hint {
            font-size: 13px;
            color: var(--muted);
            text-align: center;
            margin-bottom: 12px;
        }

        .hint a {
            color: var(--accent);
            text-decoration: underline;
            cursor: pointer;
        }

        #notesList {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .empty-state {
            text-align: center;
            padding: 28px 12px;
            color: var(--muted);
        }

        .note {
            margin-top: 4px;
            padding: 4px 6px;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .note-time {
            font-size: 11px;
            color: var(--muted);
            flex-shrink: 0;
        }

        .note-text {
            width: 100%;
            font-size: 15px;
            padding: 2px;
            background: transparent;
            white-space: pre-wrap;
            word-break: break-word;
            outline: none;
            line-height: 1.4;
        }

        .note-delete {
            background: none;
            color: var(--muted);
            border: none;
            padding: 2px 6px;
            font-size: 16px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .note-delete:hover {
            color: var(--danger);
        }

        @media (max-width: 420px) {
            h1 {
                font-size: 16px;
            }

            #noteInput {
                padding: 12px;
                min-height: 100px;
            }
        }
    </style>
</head>

<body>
    <div class="wrap">
        <textarea id="noteInput" placeholder="Neue Notiz eingeben..."></textarea>
        <div class="hint">
            Shift+Enter zum <a id="saveLink">Speichern</a> Â· Enter fÃ¼r neue
            Zeile
        </div>
        <div id="notesList"></div>
    </div>

    <script>
        // Grundapp (leicht gekÃ¼rzt, wie vorher)
        const inp = document.getElementById("noteInput");
        const list = document.getElementById("notesList");
        const saveLink = document.getElementById("saveLink");
        let notes = JSON.parse(localStorage.getItem("notes") || "[]");

        function saveNotes() {
            localStorage.setItem("notes", JSON.stringify(notes));
        }

        function addNote() {
            const text = inp.value.trim();
            if (text) {
                notes.unshift({ text, time: Date.now() });
                saveNotes();
                renderNotes();
                inp.value = "";
                inp.focus();
            }
        }
        function formatTime(ts) {
            const d = new Date(ts),
                now = new Date(),
                diffMs = now - d;
            const diffMins = Math.floor(diffMs / 60000),
                diffHours = Math.floor(diffMs / 3600000),
                diffDays = Math.floor(diffMs / 86400000);
            return d.toLocaleString("de-DE", {
                day: "2-digit",
                month: "2-digit",
                year: "numeric",
                hour: "2-digit",
                minute: "2-digit",
            });
        }

        function renderNotes() {
            if (notes.length === 0) {
                list.innerHTML = `
        <div class="empty-state"><div style="font-size:32px">ðŸ“­</div><div>Noch keine Notizen vorhanden</div></div>`;
                return;
            }
            list.innerHTML = notes
                .map(
                    (note, i) => `
        <div class="note">
          <div class="note-header">
            <div class="note-time">${formatTime(note.time)} ${note.edited ? '<span style="font-size:12px;color:#6b7280;margin-left:6px">(bearbeitet)</span>' : ""}</div>
            <button class="note-delete" onclick="deleteNote(${i})" title="LÃ¶schen">âœ•</button>
          </div>
          <div class="note-text" contenteditable="true" data-index="${i}">${escapeHtml(note.text)}</div>
        </div>`,
                )
                .join("");
            document.querySelectorAll(".note-text").forEach((el) => {
                let orig = el.textContent;
                el.addEventListener("input", () =>
                    el.classList.toggle(
                        "editing",
                        el.textContent.trim() !== orig.trim(),
                    ),
                );
                el.addEventListener("focus", () => (orig = el.textContent));
                el.addEventListener("blur", handleEdit);
                el.addEventListener("keydown", (e) => {
                    if (e.key === "Enter" && e.shiftKey) {
                        e.preventDefault();
                        el.blur();
                    }
                });
            });
        }

        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");
        }

        window.deleteNote = function (i) {
            if (confirm("Notiz wirklich lÃ¶schen?")) {
                notes.splice(i, 1);
                saveNotes();
                renderNotes();
            }
        };

        function handleEdit(e) {
            const i = parseInt(e.target.dataset.index),
                newText = e.target.textContent.trim();
            if (newText && newText !== notes[i].text) {
                notes[i].text = newText;
                notes[i].edited = true;
                saveNotes();
                renderNotes();
            } else if (!newText) {
                renderNotes();
            }
        }

        inp.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && e.shiftKey) {
                e.preventDefault();
                addNote();
            }
        });

        saveLink.addEventListener("click", (e) => {
            e.preventDefault();
            addNote();
        });

        inp.focus();
        renderNotes();

        /* --- Service Worker registration --- */
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker
                .register("sw.js")
                .then((reg) => {
                    // console.log('SW registered', reg);
                })
                .catch((err) => {
                    console.warn("SW registration failed", err);
                });
        }

        /* --- Handle Web Share Target (GET params) --- */
        function handleShareTarget() {
            const urlParams = new URLSearchParams(window.location.search);
            let title = urlParams.get("title") || "";
            let text = urlParams.get("text") || "";
            let url = urlParams.get("url") || "";

            // Helper to clean URL
            const cleanUrl = (u) => {
                try {
                    const urlObj = new URL(u);
                    // Remove text fragments
                    urlObj.hash = urlObj.hash.replace(/:~:text=.*$/i, "");
                    // Remove UTM params
                    const paramsToRemove = [];
                    for (const [key] of urlObj.searchParams) {
                        if (key.startsWith("utm_")) paramsToRemove.push(key);
                    }
                    paramsToRemove.forEach((k) => urlObj.searchParams.delete(k));
                    return urlObj.toString();
                } catch (e) {
                    return u;
                }
            };

            // Heuristic to handle Chrome's behavior where URL is often in 'text' too
            // Find any URL in text
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const foundUrls = text.match(urlRegex);

            // If we found a URL in text, and 'url' param matches or is empty, use the one from text
            if (foundUrls && foundUrls.length > 0) {
                const embeddedUrl = foundUrls[0];
                if (!url || url === embeddedUrl) {
                    url = embeddedUrl;
                }
                // Determine if 'text' is mostly just the URL. If so, clear text.
                // Otherwise, remove the URL from text to leave just the content.
                if (text.trim() === embeddedUrl) {
                    text = "";
                } else {
                    text = text.replace(embeddedUrl, "").trim();
                }
            }

            // Clean the final URL
            if (url) {
                url = cleanUrl(url);
            }

            // Construct Note
            let noteContent = "";

            // If we have actual text content (quote), format it
            if (text) {
                noteContent += `> ${text}\n\n`;
            } else if (title) {
                // Fallback: if no text but we have a title, use title as 'content' 
                // (except if title is just generic, but usually it's the page title)
                // Actually user probably wants page title in the source line or separate?
                // Let's keep it simple: Text > Title
                // But often Title is "Page Name". 
                // User said: "> QUOTE \n Source: Link"
                // If we also have a title, maybe add it? 
                // Let's ignore title strictly if we have text, or prepend it? 
                // User request implies simple quote format. Let's stick to text.
                // If text is empty (just shared a link), maybe we want the title?
                noteContent += `${title}\n\n`;
            }

            if (url) {
                noteContent += `Source: ${url}`;
            }

            noteContent = noteContent.trim();

            if (noteContent) {
                notes.unshift({ text: noteContent, time: Date.now() });
                saveNotes();
                renderNotes();
                // Clean up URL to remove share params
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // Check if we arrived via share target
        if (window.location.search) {
            handleShareTarget();
        }
    </script>
</body>

</html>